-- Store precomputed recommendations for users (generated by background job)
-- Recommendations are stored with position order; read articles are filtered at serve time
CREATE TABLE IF NOT EXISTS `user_precomputed_recommendations` (
    `user_id` VARCHAR(256) NOT NULL,
    `article_hash_id` VARCHAR(32) NOT NULL,
    `score` FLOAT NOT NULL,
    `source` VARCHAR(32) NOT NULL,
    `position` INT NOT NULL,
    `generated_at` DATETIME NOT NULL,
    PRIMARY KEY (`user_id`, `article_hash_id`),
    INDEX idx_user_position (`user_id`, `position`),
    INDEX idx_user_generated (`user_id`, `generated_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

-- Track recommendation generation state per user
-- Allows background job to process only users with new ratings
CREATE TABLE IF NOT EXISTS `user_recommendation_state` (
    `user_id` VARCHAR(256) NOT NULL PRIMARY KEY,
    `last_generated_at` DATETIME DEFAULT NULL,
    `last_rating_at` DATETIME DEFAULT NULL,
    `needs_regeneration` BOOLEAN NOT NULL DEFAULT FALSE,
    INDEX idx_needs_regen (`needs_regeneration`, `last_rating_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
